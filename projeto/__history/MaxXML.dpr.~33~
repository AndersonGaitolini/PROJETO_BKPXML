program MaxXML;

uses
  Vcl.Forms,
  Vcl.Controls,
  SysUtils,
  uDMnfebkp in 'J:\fontes\uDMnfebkp.pas' {DM_NFEDFE: TDataModule},
  uMetodosUteis in 'J:\fontes\uMetodosUteis.pas',
  uPadraoCons in 'J:\fontes\Padroes\uPadraoCons.pas' {frmPadraoCons},
  uFoPrincipal in 'J:\fontes\uFoPrincipal.pas' {foPrincipal},
  Atributos in 'J:\fontes\ORM\Atributos.pas',
  Base in 'J:\fontes\ORM\Base.pas',
  DaoFD in 'J:\fontes\ORM\DaoFD.pas',
  GerarClasse.BancoFirebird in 'J:\fontes\ORM\GerarClasse.BancoFirebird.pas',
  GerarClasse.BancoMySQL in 'J:\fontes\ORM\GerarClasse.BancoMySQL.pas',
  GerarClasse in 'J:\fontes\ORM\GerarClasse.pas',
  GerarClasseFireDac in 'J:\fontes\ORM\GerarClasseFireDac.pas',
  Configuracoes in 'J:\fontes\classes\Configuracoes.pas',
  ufoGerarClasse in 'J:\fontes\ORM\ufoGerarClasse.pas' {foGeraClasse},
  Lm_bkpdfe in 'J:\fontes\classes\Lm_bkpdfe.pas',
  uPadraoEdicao in 'J:\fontes\Padroes\uPadraoEdicao.pas' {frmPadraoEdi},
  uLoadXML in 'J:\fontes\uLoadXML.pas',
  ufoLoginPadrao in 'J:\fontes\Padroes\ufoLoginPadrao.pas' {foLoginPadrao},
  ufoLogin in 'J:\fontes\ufoLogin.pas' {foLogin},
  Usuarios in 'J:\fontes\classes\Usuarios.pas',
  uFoConsultaPadrao in 'J:\fontes\Padroes\uFoConsultaPadrao.pas' {foConsultaPadrao},
  uFoConsConfiguracao in 'J:\fontes\uFoConsConfiguracao.pas' {foConsConfiguracoes},
  ConfigPadrao in 'J:\fontes\classes\ConfigPadrao.pas',
  uFoConfigPadrao in 'J:\fontes\uFoConfigPadrao.pas' {foConfigPadrao},
  uFoConfiguracao in 'J:\fontes\uFoConfiguracao.pas' {foConfiguracao},
  uRotinas in 'J:\fontes\uRotinas.pas',
  uFoXMLSimulacao in 'J:\fontes\uFoXMLSimulacao.pas' {foXMLSimulcao},
  uFoCadUsuario in 'J:\fontes\uFoCadUsuario.pas' {foCadUsuario},
  uFoConsUsuario in 'J:\fontes\uFoConsUsuario.pas' {foConsUsuario};

var
 ShowResult : Byte;
 wMsg, wSenhaAtual, wPathMAX: string;
 SoapUsuario : TUsuarios;
 i : integer;
 wMaxOK : boolean;
{$R *.res}
begin

  Application.Initialize;
  Application.MainFormOnTaskbar := True;
  Application.CreateForm(TDM_NFEDFE, DM_NFEDFE);
  if (ParamCount = 0) then
  begin
    if not ConexaoBD(DM_NFEDFE.conConexaoFD, DM_NFEDFE.fddrfbDriver, true) then
    begin
      Application.Terminate;
      exit;
    end;

    Application.CreateForm(TfoLogin, foLogin);
    ShowResult := foLogin.ShowModal;

    if ShowResult = mrOk then
    begin
      wMsg := foLogin.statMsg.Panels[1].Text;
      SoapUsuario :=  tabUsuarios;

      FreeAndNil(foLogin); //Libera o form de Login da memória
      Application.CreateForm(TFoPrincipal, FoPrincipal); //Cria a janela main
      tabUsuarios := SoapUsuario;
      FoPrincipal.statPrincipal.Panels[1].Text := wMsg;
      Application.Run; //Roda a aplicação
      SoapUsuario.Free;
     end
    else
    if ShowResult = mrCAncel then //Caso o retorno da tela de Login seja mrCancel então
      Application.Terminate; //Encerra a aplicação  end
  end
  else
  if ParamCount = 2 then
  begin
    if ParamCount > 0 then
    for I := 0 to ParamCount do
      uMetodosUteis.AddLog('LOGMAXXML'+IntToStr(ParamCount),GetCurrentDir,'CALL_PARAMETROS: '+ ParamStr(i));

    if not ConexaoBD(DM_NFEDFE.conConexaoFD, DM_NFEDFE.fddrfbDriver, false) then
    begin
      Application.Terminate;
      exit;
    end;

   tabUsuarios.Usuario  := Trim(ParamStr(1));
   tabUsuarios.Senha    := Trim(ParamStr(2));
   uMetodosUteis.AddLog('LOGMAXXML'+IntToStr(ParamCount),GetCurrentDir,'LOGIN PARAMS('+ IntToStr(ParamCount)+'): 0['+ParamStr(0) + '] 1['+tabUsuarios.Usuario+'] 2['+ tabUsuarios.Senha+ ']');
   wSenhaAtual := uMetodosUteis.fSenhaAtual('');


   wPathMAX := ExtractFileDir(ParamStr(0));
   wPathMAX := Copy(wPathMAX, 1, LastDelimiter('\', wPathMAX));

   wMaxOK := FileExists(wPathMAX+'MaxWin.exe') or (FileExists(wPathMAX+'MaxEcv.exe'));
   uMetodosUteis.AddLog('LOGMAXXML'+IntToStr(ParamCount),GetCurrentDir,'wPathMAX: '+ wPathMAX);

   if wMaxOK and (daoLogin.fLogar(tabUsuarios)) or ((tabUsuarios.Senha = wSenhaAtual) and (Trim(LowerCase(tabUsuarios.Usuario)) = 'master'))  then
   begin
     uMetodosUteis.AddLog('LOGMAXXML'+IntToStr(ParamCount),GetCurrentDir,'wPathMAX: True e logou');
     tabConfiguracoes.id := tabUsuarios.ConfigSalva;
     Application.CreateForm(TFoPrincipal, FoPrincipal);
     Application.Run;
   end
   else
   if (wMaxOK) then
   begin
     DM_NFEDFE.Dao.StartTransaction;
     try
       uMetodosUteis.AddLog('LOGMAXXML'+IntToStr(ParamCount),GetCurrentDir,'wPathMAX: True não logou');
       tabUsuarios.Id := Usuarios.daoUsuarios.fNextID(tabUsuarios);
       if DM_NFEDFE.Dao.Inserir(tabUsuarios) = 1 then
       begin
         uMetodosUteis.AddLog('LOGMAXXML'+IntToStr(ParamCount),GetCurrentDir,'Commit: id:'+ INTTOSTR(tabUsuarios.Id));
         DM_NFEDFE.Dao.Commit;
         if daoLogin.fLogar(tabUsuarios) then
         begin
           tabConfiguracoes.id := tabUsuarios.ConfigSalva;
           Application.CreateForm(TFoPrincipal, FoPrincipal);
           Application.Run;
         end;
       end;
     except
        on E: Exception do
        begin
        if DM_NFEDFE.Dao.InTransaction then
          DM_NFEDFE.Dao.RollBack;
        end;
     end;
   end
   else
     Application.Terminate;
  end
  else
  if (ParamCount >= 3) then
  begin
    if ParamCount > 0 then
    for I := 0 to ParamCount do
      uMetodosUteis.AddLog('LOGMAXXML'+IntToStr(ParamCount),GetCurrentDir,'CALL_PARAMETROS: ' + ParamStr(i));

    if not ConexaoBD(DM_NFEDFE.conConexaoFD, DM_NFEDFE.fddrfbDriver, false) then
    begin
      Application.Terminate;
      exit;
    end;
    uMetodosUteis.AddLog('LOGMAXXML'+IntToStr(ParamCount),GetCurrentDir,'Conectou BD : XML Envio: ' + ParamStr(3));

    tabUsuarios.Usuario := Trim(ParamStr(1));
    tabUsuarios.Senha    := Trim(ParamStr(2));

   if (daoLogin.fLogar(tabUsuarios)) then
   begin
     tabConfiguracoes.id := tabUsuarios.ConfigSalva;
     daoConfiguracoes.fCarregaConfiguracoes(tabConfiguracoes,['id']);

     if uRotinas.fLoadXMLNFe(tabConfiguracoes, txTodos, false,ParamStr(3)) then
       uMetodosUteis.AddLog('LOGMAXXML'+IntToStr(ParamCount),GetCurrentDir,'fLoadXMLNFe XML: : ' + ParamStr(3));
   end;

   Application.Terminate;
  end;

    //by Anderson Gaitolini
end.
